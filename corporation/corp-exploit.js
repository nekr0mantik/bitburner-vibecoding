/** @param {NS} ns */
export async function main(ns) {
    // Configuration
    const INDUSTRY = "Restaurant";
    const CITIES = ["Aevum", "Chongqing", "Sector-12", "New Tokyo", "Ishima", "Volhaven"];
    const WAREHOUSE_SIZE = 300;
    const WAIT_CYCLES = 100; // Wait 100 cycles before selling
    const UPDATE_INTERVAL = 1000; // 1 second

    ns.disableLog("ALL");
    ns.clearLog();
    ns.tail();

    // State file for tracking progress
    const STATE_FILE = "/tmp/corp-exploit-state.txt";

    function loadState() {
        if (ns.fileExists(STATE_FILE)) {
            try {
                return JSON.parse(ns.read(STATE_FILE));
            } catch {
                return getInitialState();
            }
        }
        return getInitialState();
    }

    function getInitialState() {
        return {
            phase: 0,
            cyclesWaited: 0,
            materialsStartCycle: 0,
            realEstatePurchased: false,
            peakOffer: 0
        };
    }

    function saveState(state) {
        ns.write(STATE_FILE, JSON.stringify(state), "w");
    }

    let state = loadState();

    ns.print("=== Corporation Exploit Started ===");
    ns.print(`Current Phase: ${state.phase}`);
    ns.print("");

    while (true) {
        try {
            const corp = ns.corporation.getCorporation();

            ns.clearLog();
            ns.print("=== Corporation Exploit Status ===");
            ns.print(`Phase: ${state.phase}`);
            ns.print(`Funds: $${ns.formatNumber(corp.funds)}`);
            ns.print(`State: ${corp.state}`);

            if (state.phase === 4) {
                ns.print(`Cycles Waited: ${state.cyclesWaited}/${WAIT_CYCLES}`);
            }

            ns.print("");

            // Phase execution
            if (state.phase === 0) {
                await phase0_CreateRestaurant(ns, corp, state);
            } else if (state.phase === 1) {
                await phase1_ExpandCities(ns, corp, state);
            } else if (state.phase === 2) {
                await phase2_UpgradeWarehouses(ns, corp, state);
            } else if (state.phase === 3) {
                await phase3_BuyRealEstate(ns, corp, state);
            } else if (state.phase === 4) {
                await phase4_WaitCycles(ns, corp, state);
            } else if (state.phase === 5) {
                await phase5_HireEmployees(ns, corp, state);
            } else if (state.phase === 6) {
                await phase6_BuyAdVerts(ns, corp, state);
            } else if (state.phase === 7) {
                await phase7_SellRealEstate(ns, corp, state);
            } else if (state.phase === 8) {
                await phase8_MonitorInvestment(ns, corp, state);
            }

            saveState(state);

        } catch (error) {
            ns.print(`ERROR: ${error}`);
        }

        await ns.sleep(UPDATE_INTERVAL);
    }

    /**
     * PHASE 0: Create Restaurant division
     */
    async function phase0_CreateRestaurant(ns, corp, state) {
        ns.print("=== PHASE 0: Create Restaurant ===");

        const divisions = corp.divisions || [];
        if (!divisions.includes(INDUSTRY)) {
            try {
                ns.corporation.expandIndustry(INDUSTRY, INDUSTRY);
                ns.print(`✓ Created ${INDUSTRY} division`);
                state.phase = 1;
            } catch (e) {
                ns.print(`⏳ Waiting to create ${INDUSTRY} division`);
            }
        } else {
            ns.print(`✓ ${INDUSTRY} division exists`);
            state.phase = 1;
        }
    }

    /**
     * PHASE 1: Expand to all cities
     */
    async function phase1_ExpandCities(ns, corp, state) {
        ns.print("=== PHASE 1: Expand to All Cities ===");

        const division = ns.corporation.getDivision(INDUSTRY);
        const divisionCities = division.cities || [];

        for (const city of CITIES) {
            if (!divisionCities.includes(city)) {
                try {
                    ns.corporation.expandCity(INDUSTRY, city);
                    ns.print(`✓ Expanded to ${city}`);
                } catch (e) {
                    ns.print(`⏳ Can't afford expansion to ${city}`);
                    return;
                }
            }
        }

        ns.print(`✓ Expanded to all cities`);
        state.phase = 2;
    }

    /**
     * PHASE 2: Upgrade warehouses to 300
     */
    async function phase2_UpgradeWarehouses(ns, corp, state) {
        ns.print("=== PHASE 2: Upgrade Warehouses ===");

        for (const city of CITIES) {
            // Buy warehouse if needed
            let hasWarehouse = true;
            try {
                ns.corporation.getWarehouse(INDUSTRY, city);
            } catch {
                hasWarehouse = false;
            }

            if (!hasWarehouse) {
                try {
                    ns.corporation.purchaseWarehouse(INDUSTRY, city);
                    ns.print(`✓ Purchased warehouse in ${city}`);
                } catch (e) {
                    ns.print(`⏳ Can't afford warehouse in ${city}`);
                    return;
                }
            }

            // Upgrade warehouse to 300
            const warehouse = ns.corporation.getWarehouse(INDUSTRY, city);
            if (warehouse.size < WAREHOUSE_SIZE) {
                try {
                    const neededLevels = Math.ceil((WAREHOUSE_SIZE - warehouse.size) / 100);
                    ns.corporation.upgradeWarehouse(INDUSTRY, city, neededLevels);
                    ns.print(`✓ Upgraded warehouse in ${city} to ${WAREHOUSE_SIZE}`);
                } catch (e) {
                    ns.print(`⏳ Can't afford warehouse upgrade in ${city}`);
                    return;
                }
            }
        }

        ns.print(`✓ All warehouses at ${WAREHOUSE_SIZE}`);
        state.phase = 3;
    }

    /**
     * PHASE 3: Buy Real Estate to fill warehouses
     */
    async function phase3_BuyRealEstate(ns, corp, state) {
        ns.print("=== PHASE 3: Fill Warehouses with Real Estate ===");

        if (!state.realEstatePurchased) {
            for (const city of CITIES) {
                const warehouse = ns.corporation.getWarehouse(INDUSTRY, city);
                const realEstate = ns.corporation.getMaterial(INDUSTRY, city, "Real Estate");

                // Calculate how much Real Estate we can fit
                // Real Estate size = 0.005 per unit
                const maxRealEstate = Math.floor(warehouse.size / 0.005);
                const needed = Math.max(0, maxRealEstate - realEstate.stored);

                if (needed > 0) {
                    const result = ns.corporation.bulkPurchase(INDUSTRY, city, "Real Estate", needed);
                    if (result > 0) {
                        ns.print(`✓ ${city}: Purchased ${result} Real Estate`);
                    } else {
                        ns.print(`⏳ ${city}: Can't afford Real Estate`);
                        return;
                    }
                }
            }

            state.realEstatePurchased = true;
            state.materialsStartCycle = 0; // Will start counting next phase
            ns.print(`✓ All warehouses filled with Real Estate`);
        }

        state.phase = 4;
    }

    /**
     * PHASE 4: Wait 100 cycles
     */
    async function phase4_WaitCycles(ns, corp, state) {
        ns.print("=== PHASE 4: Waiting 100 Cycles ===");
        ns.print(`Cycles: ${state.cyclesWaited}/${WAIT_CYCLES}`);
        ns.print(`Time: ${((state.cyclesWaited * 2) / 60).toFixed(1)} / 3.3 minutes`);

        // Count cycles based on state changes (START = new cycle)
        if (corp.state === "START") {
            state.cyclesWaited++;
            ns.print(`✓ Cycle ${state.cyclesWaited} completed`);
        }

        if (state.cyclesWaited >= WAIT_CYCLES) {
            ns.print(`✓ Waited ${WAIT_CYCLES} cycles!`);
            state.phase = 5;
        }
    }

    /**
     * PHASE 5: Hire 3 employees (all Business) in each city
     */
    async function phase5_HireEmployees(ns, corp, state) {
        ns.print("=== PHASE 5: Hire Employees ===");

        for (const city of CITIES) {
            // Get or create office
            let office;
            try {
                office = ns.corporation.getOffice(INDUSTRY, city);
            } catch {
                // No office, need to create one (size 3)
                try {
                    ns.corporation.upgradeOfficeSize(INDUSTRY, city, 3);
                    office = ns.corporation.getOffice(INDUSTRY, city);
                    ns.print(`✓ Created office in ${city}`);
                } catch (e) {
                    ns.print(`⏳ Can't afford office in ${city}`);
                    return;
                }
            }

            // Hire 3 employees in Business
            const businessEmployees = office.employeeJobs["Business"] || 0;
            if (businessEmployees < 3) {
                const needed = 3 - businessEmployees;
                for (let i = 0; i < needed; i++) {
                    const hired = ns.corporation.hireEmployee(INDUSTRY, city, "Business");
                    if (!hired) {
                        ns.print(`⏳ Failed to hire Business in ${city}`);
                        return;
                    }
                }
                ns.print(`✓ ${city}: Hired 3 Business employees`);
            }
        }

        ns.print(`✓ All employees hired`);
        state.phase = 6;
    }

    /**
     * PHASE 6: Hire 10 AdVerts
     */
    async function phase6_BuyAdVerts(ns, corp, state) {
        ns.print("=== PHASE 6: Buy AdVerts ===");

        const division = ns.corporation.getDivision(INDUSTRY);
        const currentAdVerts = division.numAdVerts || 0;

        if (currentAdVerts < 10) {
            try {
                ns.corporation.hireAdVert(INDUSTRY);
                ns.print(`✓ Hired AdVert ${currentAdVerts + 1}/10`);
            } catch (e) {
                ns.print(`⏳ Can't afford AdVert yet`);
            }
        } else {
            ns.print(`✓ All 10 AdVerts hired`);
            state.phase = 7;
        }
    }

    /**
     * PHASE 7: Sell all Real Estate
     */
    async function phase7_SellRealEstate(ns, corp, state) {
        ns.print("=== PHASE 7: SELL REAL ESTATE ===");
        ns.print("Setting all cities to sell MAX at MP...");

        // Set all cities to sell Real Estate
        for (const city of CITIES) {
            try {
                ns.corporation.sellMaterial(INDUSTRY, city, "Real Estate", "MAX", "MP");
                ns.print(`✓ ${city}: Selling Real Estate`);
            } catch (e) {
                ns.print(`⚠ ${city}: Failed to set selling`);
            }
        }

        ns.print(`✓ All Real Estate set to sell!`);
        ns.print(`Go to "Find Investors" NOW!`);
        state.phase = 8;
        state.peakOffer = 0;
    }

    /**
     * PHASE 8: Monitor investment offer
     */
    async function phase8_MonitorInvestment(ns, corp, state) {
        ns.print("=== PHASE 8: Monitor Investment ===");

        try {
            const offer = ns.corporation.getInvestmentOffer();

            ns.print(`Investment Round: ${offer.round}`);
            ns.print(`Current Offer: $${ns.formatNumber(offer.funds)}`);
            ns.print(`Peak Offer: $${ns.formatNumber(state.peakOffer)}`);

            if (offer.funds > state.peakOffer) {
                state.peakOffer = offer.funds;
            }

            // Check if offer is dropping
            if (state.peakOffer > 0 && offer.funds < state.peakOffer * 0.95) {
                ns.print(`⚠ OFFER DROPPING! Peak was $${ns.formatNumber(state.peakOffer)}`);
                ns.print(`ACCEPT THE OFFER NOW!`);
            }

            // Check Real Estate levels
            let totalRealEstate = 0;
            for (const city of CITIES) {
                const material = ns.corporation.getMaterial(INDUSTRY, city, "Real Estate");
                totalRealEstate += material.stored;
            }
            ns.print(`Real Estate remaining: ${totalRealEstate.toFixed(0)}`);

            if (totalRealEstate < 100) {
                ns.print(`⚠ Real Estate nearly sold out! ACCEPT OFFER!`);
            }

        } catch (e) {
            ns.print(`Waiting for investment offer...`);
        }
    }
}
